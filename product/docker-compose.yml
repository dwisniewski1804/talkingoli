version: '3.3'

services:
  talkingoli-api:
    build:
      context: .
      dockerfile: infra/docker/api.Dockerfile
    env_file:
      - .env
    environment:
      API_PORT: ${API_PORT:-3000}
      MONGO_URI: ${MONGO_URI}
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
    ports:
      - "${API_PORT:-3000}:3000"
    depends_on:
      - talkingoli-mongo
      - talkingoli-redis
    networks:
      - talkingoli-net

  talkingoli-web:
    build:
      context: .
      dockerfile: infra/docker/web.Dockerfile
      args:
        VITE_API_BASE_URL: http://localhost:${API_PORT:-3000}
    env_file:
      - .env
    ports:
      - "${WEB_PORT:-5173}:4173"
    depends_on:
      - talkingoli-api
    networks:
      - talkingoli-net

  talkingoli-mongo:
    image: mongo:7.0
    restart: unless-stopped
    environment:
      MONGO_INITDB_DATABASE: product
    ports:
      - "27017:27017"
    volumes:
      - talkingoli-mongo-data:/data/db
    networks:
      - talkingoli-net

  talkingoli-redis:
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - "6379:6379"
    networks:
      - talkingoli-net

  talkingoli-minio:
    image: minio/minio:RELEASE.2024-11-07T00-52-20Z
    env_file:
      - .env
    command: server /data --console-address ":9001"
    ports:
      - "${MINIO_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    volumes:
      - talkingoli-minio-data:/data
    networks:
      - talkingoli-net

  talkingoli-mailhog:
    image: mailhog/mailhog:v1.0.1
    restart: unless-stopped
    ports:
      - "${MAILHOG_SMTP_PORT:-1025}:1025"
      - "${MAILHOG_HTTP_PORT:-8025}:8025"
    networks:
      - talkingoli-net

volumes:
  talkingoli-mongo-data:
  talkingoli-minio-data:

networks:
  talkingoli-net:
    driver: bridge
